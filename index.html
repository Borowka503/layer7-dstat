window.onload = () => {
  let info = document.getElementById("info");

  let chart = Highcharts.chart("chart", {
    exporting: {
      enabled: true,
    },
    chart: {
      type: "area",
    },
    title: {
      text: "Layer7 DSTAT",
    },
    xAxis: {
      type: "datetime",
    },
    yAxis: {
      title: {
        text: "",
      },
    },
    series: [
      {
        name: "Requests",
        data: [],
      },
    ],
  });

  info.innerText = "Capturing requests from " + location.host + "/dstat";

  function setRequestCount() {
    fetch("https://site.com/api/l7s.php?id=" + sessionStorage.getItem("l7k"))
      .then((response) => response.json())
      .then((data) => {
        let count = data.count || 0; // Check if 'count' exists in the response
        let requests = Number(count);
        let time = new Date().getTime();
        chart.series[0].addPoint(
          [time, requests],
          true,
          chart.series[0].points.length > 60
        );
      })
      .catch((error) => {
        console.error("Error:", error);
      })
      .finally(() => {
        setTimeout(setRequestCount, 3000);
      });
  }

  setRequestCount();
};
